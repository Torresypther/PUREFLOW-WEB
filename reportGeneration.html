<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generate PDF Report</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    />
    <link rel="stylesheet" href="reportGeneration.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://rawgit.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>

    <!-- Make sure this is a module -->
  </head>
  <body>
    <!-- Navbar -->
    <nav class="nav">
      <div class="nav-logo">
        <p>PureFlow</p>
      </div>
      <div class="nav-menu" id="navMenu">
        <ul>
          <li><a href="index.html" class="link">Home</a></li>
          <li><a href="#" class="link">Staff</a></li>
          <li><a href="#" class="link">About</a></li>
        </ul>
      </div>
      <div class="nav-button">
        <a href="reportGeneration.html">
          <button class="btn white-btn" id="generateReportBtn">
            Generate Report
          </button>
        </a>
      </div>
      <div class="nav-menu-btn">
        <i class="bx bx-menu" onclick="myMenuFunction()"></i>
      </div>
    </nav>

    <!-- Container for Dropdown and Button -->
    <div class="form-container">
      <h1 class="title">Generate PDF Report</h1>
      <!-- Dropdown for Report Type -->
      <select id="reportType" class="report-type-dropdown">
        <option value="daily">Daily Report</option>
        <option value="weekly">Weekly Report</option>
        <option value="monthly">Monthly Report</option>
        <option value="annual">Annual Report</option>
      </select>

      <button id="generateReport" class="button">Generate Report</button>
    </div>

    <!-- Container for Generated Report -->
<div id="reportContainer" class="report-container" style="display: none">
  <!-- Display Date Range -->
  <p id="reportDateRange" class="report-date-range"></p>
  <div class="chart-container">
    <canvas id="reportChart"></canvas>
  </div>

  <table class="report-table">
    <thead>
      <tr>
        <th>Parameter</th>
        <th>Average</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Temperature</td>
        <td id="averageTemperature">--</td>
      </tr>
      <tr>
        <td>Turbidity</td>
        <td id="averageTurbidity">--</td>
      </tr>
      <tr>
        <td>Water Depth</td>
        <td id="averageWaterDepth">--</td>
      </tr>
    </tbody>
  </table>

  <!-- New button to trigger PDF download -->
  <button id="downloadPDF" class="button">
    Download PDF
  </button>
</div>

<script type="module">
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
  } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";
  import { db } from "./config.js";
  
  let chart;
  
  // Function to fetch data from Firestore based on report type
  async function fetchDataFromFirebase(reportType) {
    let data = {
      temperatureData: [],
      turbidityData: [],
      waterDepthData: [],
    };
  
    const today = new Date();
    let startDate = new Date();
    let endDate = today;
  
    // Set date range based on report type
    if (reportType === "daily") {
      startDate = today;
      endDate = today;
    } else if (reportType === "weekly") {
      startDate.setDate(today.getDate() - 7);
    } else if (reportType === "monthly") {
      startDate.setMonth(today.getMonth() - 1);
    } else if (reportType === "annual") {
      startDate.setFullYear(today.getFullYear() - 1);
    }
  
    const waterQualityCollection = collection(db, "water_parameters"); // Collection name
    // Query using the timestamp field to filter data
    const q = query(
      waterQualityCollection,
      where("timestamp", ">=", startDate),
      where("timestamp", "<=", endDate)
    );
  
    try {
      // Fetch data from Firestore
      const snapshot = await getDocs(q);
      console.log(snapshot.docs.length); // Check how many documents are fetched
  
      snapshot.forEach((doc) => {
        const dataDoc = doc.data();
        console.log(dataDoc); // Log the data fetched for debugging
  
        // Assuming fields are named 'temperature', 'turbidity', and 'waterDepth'
        data.temperatureData.push(dataDoc.temperature);
        data.turbidityData.push(dataDoc.turbidity);
        data.waterDepthData.push(dataDoc.waterDepth);
      });
  
      console.log("Fetched Data:", data); // Log the data to ensure it's fetched correctly
      return { data, startDate, endDate };
    } catch (error) {
      console.error("Error fetching data:", error);
      return { data, startDate, endDate };
    }
  }
  
  // Event listener for generating the report
  document
    .getElementById("generateReport")
    .addEventListener("click", async () => {
      const reportContainer = document.getElementById("reportContainer");
      reportContainer.style.display = "block";
  
      const reportType = document.getElementById("reportType").value;
  
      // Fetch data based on the selected report type
      const { data, startDate, endDate } = await fetchDataFromFirebase(
        reportType
      );
  
      // Destroy previous chart if it exists
      if (chart) {
        chart.destroy();
      }
  
      // Ensure there is data to display
      if (data.temperatureData.length === 0) {
        alert("No data available for the selected range.");
        return;
      }
  
      // Create a new line chart
      const ctx = document.getElementById("reportChart").getContext("2d");
  
      // Adjust labels based on the fetched data length
      const labels = Array.from(
        { length: data.temperatureData.length },
        (_, i) => `Day ${i + 1}`
      );
  
      chart = new Chart(ctx, {
        type: "line", // Set chart type to line (linear)
        data: {
          labels: labels,
          datasets: [
            {
              label: "Temperature (°C)",
              data: data.temperatureData,
              fill: false, // Line chart with no fill
              borderColor: "#FF6384", // Line color
              tension: 0.1, // Controls the curve of the line (linear)
              borderWidth: 2, // Line thickness
              pointRadius: 5, // Radius of points on the line
              pointBackgroundColor: "#FF6384", // Color of the points
            },
            {
              label: "Turbidity (NTU)",
              data: data.turbidityData,
              fill: false,
              borderColor: "#36A2EB",
              tension: 0.1,
              borderWidth: 2,
              pointRadius: 5,
              pointBackgroundColor: "#36A2EB",
            },
            {
              label: "Water Depth (m)",
              data: data.waterDepthData,
              fill: false,
              borderColor: "#FFCE56",
              tension: 0.1,
              borderWidth: 2,
              pointRadius: 5,
              pointBackgroundColor: "#FFCE56",
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true, // Show legend
              position: "top", // Position of the legend
            },
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Days",
              },
            },
            y: {
              beginAtZero: true, // Start Y-axis from 0
              title: {
                display: true,
                text: "Values",
              },
              ticks: {
                stepSize: 1, // Set step size for the Y-axis
              },
            },
          },
        },
      });
  
      // Calculate averages for each parameter
      const averageTemperature =
        data.temperatureData.reduce((a, b) => a + b, 0) /
        data.temperatureData.length;
      const averageTurbidity =
        data.turbidityData.reduce((a, b) => a + b, 0) /
        data.turbidityData.length;
      const averageWaterDepth =
        data.waterDepthData.reduce((a, b) => a + b, 0) /
        data.waterDepthData.length;
  
      document.getElementById(
        "averageTemperature"
      ).textContent = `${averageTemperature.toFixed(2)} °C`;
      document.getElementById(
        "averageTurbidity"
      ).textContent = `${averageTurbidity.toFixed(2)} NTU`;
      document.getElementById(
        "averageWaterDepth"
      ).textContent = `${averageWaterDepth.toFixed(2)} meters`;
  
      const dateRangeText = `Date Range: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
      document.getElementById("reportDateRange").textContent =
        dateRangeText;
  
      // Show the download button
      document.getElementById("downloadReport").style.display = "inline-block";
    });

   // Download PDF function
document.getElementById("downloadPDF").addEventListener("click", () => {
  const element = document.getElementById("reportContainer");
  
  // Options for html2pdf
  const opt = {
    margin: 0.5, // Set small margins to fit everything on one page
    filename: "water_quality_report.pdf",
    html2canvas: { scale: 2 }, // Adjust the scale of the rendering
    jsPDF: { unit: "in", format: "letter", orientation: "landscape" }, // Landscape mode
  };
  
  // Generate PDF with adjusted settings
  html2pdf().from(element).set(opt).save();
});


</script>
  </body>
</html>
