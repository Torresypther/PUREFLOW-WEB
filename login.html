<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="login.css" />
    <title>PureFlow - Water Quality Monitoring</title>
  </head>
  <body>
    <div class="wrapper">
      <!-- Navbar -->
      <nav class="nav">
        <div class="nav-logo">
          <p>PureFlow</p>
        </div>
        <div class="nav-menu" id="navMenu">
          <ul>
            <li><a href="index.html" id="homeLink" class="link">Home</a></li>
            <li>
              <a href="reportGeneration.html" id="reportLink" class="link"
                >Reports</a
              >
            </li>
            <li>
              <a href="staffManagement.html" id="staffLink" class="hidden"
                >Staff Page</a
              >
            </li>
            <li><a href="about.html" id="aboutLink" class="link">About</a></li>
          </ul>
        </div>
        <div class="nav-button">
          <button class="btn white-btn" id="signInBtn">
            <a href="login.html">Sign In</a>
          </button>
        </div>
      </nav>

      <div class="form-box">
        <!-- Login Form -->
        <div class="login-container" id="login">
          <div class="top">
            <span>
              Don't have an account?
              <a href="#" onclick="requestAccount()">Request an Account</a>
            </span>
            <header>Login</header>
          </div>

          <div class="input-box">
            <input
              type="text"
              class="input-field"
              id="email"
              placeholder="Email"
            />
            <i class="bx bx-user"></i>
          </div>
          <div class="input-box">
            <input
              type="password"
              class="input-field"
              id="password"
              placeholder="Password"
            />
            <i class="bx bx-lock-alt"></i>
            <i class="bx bx-show" id="togglePassword" style="cursor: pointer;"></i>
          </div>
          

          <input type="submit" class="submit" value="Sign In" id="loginBtn" />

          <div class="two-col">
            <div class="one">
              <input type="checkbox" id="login-check" />
              <label for="login-check"> Remember Me</label>
            </div>
            <div class="two">
              <label><a href="#">Forgot password?</a></label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="customConfirm" class="modal" style="display: none">
      <div class="modal-content">
        <i
          id="confirmIcon"
          class="bi bi-question-circle"
          style="font-size: 2rem; color: #ffc107"
        ></i>
        <h2 id="confirmTitle">Confirmation</h2>
        <p id="confirmMessage">Are you sure you want to download the report?</p>
        <div class="modal-buttons">
          <button class="btn confirm-btn" id="confirmYesBtn">Yes</button>
          <button class="btn cancel-btn" id="confirmNoBtn">Cancel</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { db, auth } from "./config.js";
      import {
        getDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";
      import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js";

      // Handle login process
      async function handleLogin() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        try {
          const userCredential = await signInWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;
          const userId = user.uid;

          alert(`Welcome, ${user.email}!`);

          // Get the user role from Firestore
          const userRole = await getUserRole(userId);

          // Redirect based on user role
          if (userRole === "admin") {
            window.location.href = "index.html";
          } else if (userRole === "staff") {
            window.location.href = "index.html";
          } else {
            window.location.href = "index.html";
          }

          // Disable the Staff link if the user is staff
          disableStaffLink(userRole);
        } catch (error) {
          console.error("Login error:", error.message);
          alert("Login failed. Please check your email and password.");
        }
      }

      const signInBtn = document.getElementById("signInBtn");
      const signOutBtn = document.getElementById("signOutBtn");
      const reportLink = document.getElementById("reportLink");
      const staffLink = document.getElementById("staffLink");
      const generateReportBtn = document.getElementById("generateReportBtn");

      // Get user role from Firestore
      async function getUserRole(userId) {
        try {
          const userDocRef = doc(db, "users", userId);
          const userDoc = await getDoc(userDocRef);

          if (userDoc.exists()) {
            return userDoc.data().role;
          } else {
            console.error("No such user document found!");
            return null;
          }
        } catch (error) {
          console.error("Error fetching user role:", error.message);
          return null;
        }
      }

      // Disable Staff link if user is a staff member
      function disableStaffLink(role) {
        const staffLink = document.getElementById("staffLink");

        if (role === "staff") {
          staffLink.style.pointerEvents = "none";
          staffLink.style.opacity = "0.5";
        }
      }

      // Disable unnecessary links based on the role
      document.addEventListener("DOMContentLoaded", function () {
        const loginBtn = document.getElementById("loginBtn");
        if (loginBtn) {
          loginBtn.addEventListener("click", handleLogin);
        }

        // Disable links except Home and About
        const links = document.querySelectorAll(".nav-menu a");
        links.forEach((link) => {
          if (
            link !== document.getElementById("homeLink") &&
            link !== document.getElementById("aboutLink")
          ) {
            link.addEventListener("click", (e) => e.preventDefault());
            link.style.pointerEvents = "none";
            link.style.opacity = "0.5";
          }
        });
      });

      // Account request handler
      function requestAccount() {
        alert("Please contact the admin to request an account.");
      }

      // Show the confirmation modal
      function showConfirmation(message) {
        document.getElementById("confirmMessage").innerText = message;
        const modal = document.getElementById("customConfirm");
        modal.style.display = "block";

        // Handle Yes button click
        document.getElementById("confirmYesBtn").onclick = function () {
          modal.style.display = "none";
          alert("Action confirmed.");
        };

        // Handle No button click
        document.getElementById("confirmNoBtn").onclick = function () {
          modal.style.display = "none";
          alert("Action canceled.");
        };
      }

      // Example of triggering the confirmation modal (like for downloading a report)
      document
        .getElementById("reportLink")
        .addEventListener("click", function (e) {
          e.preventDefault(); // Prevent the default link behavior
          showConfirmation("Are you sure you want to download the report?");
        });

      // Select the password field and the eye icon
      const passwordField = document.getElementById("password");
      const togglePasswordIcon = document.getElementById("togglePassword");

      // Add click event listener to the eye icon
      togglePasswordIcon.addEventListener("click", function () {
        // Check if the password field type is "password"
        if (passwordField.type === "password") {
          // Change the field type to text to show the password
          passwordField.type = "text";
          // Change the eye icon to "open" (or you can add different styling here)
          togglePasswordIcon.classList.remove("bx-show");
          togglePasswordIcon.classList.add("bx-hide");
        } else {
          // Change the field type back to "password" to hide the password
          passwordField.type = "password";
          // Change the eye icon back to "closed"
          togglePasswordIcon.classList.remove("bx-hide");
          togglePasswordIcon.classList.add("bx-show");
        }
      });
    </script>
  </body>
</html>
